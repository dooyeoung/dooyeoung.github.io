---
layout: post
title: "React Flow로 대규모 목표 트리뷰 구현 및 최적화하기"
categories: "Frontend"
tags: ["react-flow"]
sidebar: ['article-menu']
---

기존에는 목표의 위계 관계를 트리 테이블로 표현하고 있었습니다. 하지만 전체 목표를 한눈에 펼쳐보고 싶다는 요구사항이 있었고, 이를 해결하기 위해 트리뷰(Tree View) 형태의 UI를 프로토타입으로 만들어보기로 했습니다. 이 글에서는 `react-flow` 라이브러리를 사용하여 수만 개의 목표 데이터를 트리뷰로 구현하고, 그 과정에서 마주한 성능 문제를 해결한 경험을 공유합니다.

### **왜 시작했나?**

가장 큰 목표는 **"과연 목표 트리뷰가 실제 서비스에서 쓸만할까?"** 라는 질문에 답을 찾는 것이었습니다. 특히 3만 개 이상의 대규모 목표 데이터를 다룰 때 성능 문제가 없는지 확인하는 것이 중요했습니다.

![](/assets/images/posts/2024-03-15-react-flow-treeview-1.png)

### **어떻게 만들었나?**

처음에는 `konva`(캔버스 기반)나 `d3`(SVG 기반)를 고려했지만, 코드 관리의 용이성을 생각해 추상화가 잘 되어있는 `react-flow`를 선택했습니다. `react-flow`는 노드(node)와 엣지(edge) 개념이 있는 모든 종류의 다이어그램을 그리는 데 사용할 수 있는 강력한 라이브러리입니다.

작업 흐름은 다음과 같았습니다.

1.  백엔드에서 받은 중첩(nested)된 형태의 위계 데이터에서 `react-flow`가 요구하는 노드와 엣지 정보를 추출합니다.
2.  각 노드를 적절한 위치에 표시하기 위해 x, y 좌표를 계산합니다. 처음에는 공식 문서에서 권장하는 `d3-hierarchy`나 `darge` 라이브러리를 사용했지만, 3만 개 노드의 좌표를 계산하는 데 1초 이상이 소요되어 성능 문제가 있었습니다.

### **어떻게 개선했나?**

초기 구현 버전은 3만 개의 목표 데이터를 렌더링하는 데 심각한 성능 문제를 보였습니다. 가장 큰 병목 지점은 **좌표 계산**과 **렌더링**이었습니다.

#### **1. 좌표 계산 최적화**

`d3-hierarchy`와 같은 라이브러리 대신, 더 간단하고 빠른 방법으로 직접 좌표를 계산하기로 했습니다.

1.  **Post-order 순회:** 가장 아래 자식 노드부터 시작하여, 각 노드의 너비(자식 노드들의 너비 합)를 계산하며 올라옵니다.
2.  **Pre-order 순회:** 최상위 부모 노드부터 시작하여, 1번에서 계산한 너비 비율에 따라 자식 노드들의 x, y 좌표를 순차적으로 계산합니다.

이 간단한 방식으로 3만 개 목표의 좌표 계산 시간을 **100ms 이내**로 단축할 수 있었습니다.

![](/assets/images/posts/2024-03-15-react-flow-treeview-2.png)

#### **2. 렌더링 최적화**

`react-flow`는 `onlyRenderVisibleElements`라는 렌더링 최적화 옵션을 제공하지만, 3만 개의 노드와 엣지 데이터를 한 번에 전달하면 초기 로딩에 5초 이상이 걸리는 문제가 있었습니다.

그래서 현재 화면에 보이는(viewport) 노드와 엣지만 `react-flow`에 전달하는 방식으로 변경했습니다.

1.  전체 목표 트리를 표현하는 데 필요한 총 영역의 크기를 계산합니다.
2.  `react-flow`의 `onMove` 이벤트에서 현재 화면의 확대/축소 및 이동 정보(transform)를 얻습니다.
3.  1번과 2번 정보를 조합하여 현재 화면에 보여야 할 노드의 범위를 계산합니다.
4.  계산된 범위에 해당하는 노드와 엣지만 `react-flow` 컴포넌트에 전달합니다.

![](/assets/images/posts/2024-03-15-react-flow-treeview-3.png)

이러한 최적화를 통해 3만 개의 데이터도 부드럽게 탐색할 수 있는 목표 트리뷰 프로토타입을 완성할 수 있었습니다.
